{% extends 'base.html' %}
{% load static %}

{% block title %}
   Result Visualizer 
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/visualizer.css' %}">

<script>
  const neededData = JSON.parse('{{ needed_data|safe }}');
</script>

<div class="chart-container"> 
  <div class="chart-row">
    {% if branch_gpa_chart_data %}
      <div class="chart-section branch-gpa-chart">
        <h2 class="chart-title">Branch GPA</h2>
        <div id="branch-gpa-chart" class="raw-data">
          <pre>{{ branch_gpa_chart_data|safe }}</pre>
        </div>
      </div>
    {% else %}
      <div class="chart-section semester-avg-chart">
        <h2 class="chart-title">Semester Average Score</h2>
        <div id="semester-avg-data" class="raw-data">
          <pre>{{ semester_avg_data|safe }}</pre>
        </div>
      </div>
    {% endif %}
  
    <div class="chart-section cgpa-chart">
      <h2 class="chart-title">CGPA & GPA</h2>
      <div id="combined-chart-data" class="raw-data">
        <pre>{{ combined_chart_data|safe }}</pre>
      </div>
    </div>
  </div>

  <div class="chart-row">
    <div class="chart-section level-boxplot">
      <h2 class="chart-title">Per Level boxplot</h2>
      <div id="level-boxplot-data" class="raw-data">
        <pre>{{ level_boxplot_data|safe }}</pre>
      </div>
    </div>

    <div class="chart-section semester-boxplot">
      <h2 class="chart-title">Per Semester boxplot</h2>
      <div id="semester-boxplot-data" class="raw-data">
        <pre>{{ semester_boxplot_data|safe }}</pre>
      </div>
    </div>
  </div>

  <div class="chart-row">
    <div class="chart-section scatter-plot">
      <h2 class="chart-title">Course Score Distribution</h2>
      <div id="scatter-plot-container" class="raw-data">
        <pre>{{ scatter_plot_data|safe }}</pre>
      </div>
    </div>
  
    <div class="chart-section overall-boxplot">
      <h2 class="chart-title">Overall Boxplot</h2>
      <div id="all-boxplot-data" class="raw-data">
        <pre>{{ all_scores_boxplot_data|safe }}</pre>
      </div>
    </div>
  </div>

  <div class="chart-row">
    {% if semester_avg_data %}
      <div class="chart-section alternate-semester-avg-chart">
        <h2 class="chart-title">Semester Average Score</h2>
        <div id="semester-avg-data" class="raw-data">
          <pre>{{ semester_avg_data|safe }}</pre>
        </div>
      </div>
    {% endif %}

    {% if branch_avg_data %}
      <div class="chart-section branch-avg-chart">
        <h2 class="chart-title">Branch Average Score per Semester</h2>
        <div id="branch-avg-data" class="raw-data">
          <pre>{{ branch_avg_data|safe }}</pre>
        </div>
      </div>
    {% endif %}
  </div>

  <div class="chart-row">
    {% if overall_branch_pie_chart_data %}
      <div class="chart-section branch-pie-chart">
        <h2 class="chart-title">Overall Branch Distribution</h2>
        <div id="semester-boxplot-data" class="raw-data">
          <pre>{{ overall_branch_pie_chart_data|safe }}</pre>
        </div>
      </div>
    {% endif %}
  
    {% if semester_distribution_pie_data %}
      <div class="chart-section semester-distribution">
        <h2 class="chart-title">
          Branch Distribution of Courses per Semester
        </h2>
        <div class="semester-distribution-inner">
          {% for pie_chart_data in semester_distribution_pie_data %}
              <div class="semester-distribution-item raw-data">
                  <pre>{{ pie_chart_data|safe }}</pre>
              </div>
            {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>

  <div class="chart-row">
    {% if branch_distribution_data %}
      <div class="chart-section branch-distribution-stacked">
        <h2 class="chart-title">Branch Distribution by Semester</h2>
         <div id="branch-distribution-chart" class="raw-data">
          <pre>{{ branch_distribution_data|safe }}</pre>
        </div>
      </div>
    {% endif %}
  </div>

  <div class="chart-row">
    <div class="chart-section pass-rate-chart">
      <h2 class="chart-title">Course Pass Rate by Branch</h2>
      <div id="pass-rate-data" class="raw-data">
        <pre>{{ pass_rate_data|safe }}</pre>
      </div>
    </div>
  </div>
</div>

<br class="spacer">

<aside class="advisory-section">
  <button type="submit" id="view_analysis" class="btn btn-primary py-1 analysis-button">Click here to view detailed analysis of your result
  </button>
  <content id="advisory">
    <h2 class="advisory-section-title text-2xl bold text-center">Your Overall Semester Performance</h2>
    <p id="studentSemesterPerformance"></p>
    <h2 class="advisory-section-title text-2xl bold text-center">Indepth Analysis Of Your Semester Performance</h2>
    <p id="studentSpecificPerformance"></p>
    <h2 class="advisory-section-title text-2xl bold text-center">Advice To Improve Performance</h2>
    <p id="toDoMoreOrNot"></p>
    <button type="submit" id="minimize_analysis" class="btn btn-primary py-1 minimize-button">
      Click here to minimize detailed analysis of your result
    </button>
  </content>
</aside>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function safeJSONParse(jsonString) {
        if (!jsonString) return null;
        try {
            return JSON.parse(jsonString);
        } catch (e) {
            console.error("Error parsing JSON:", e);
            return null;
        }
    }

    function generateBranchGPAChart() {
        const container = document.getElementById('branch-gpa-chart');
        if (!container) return;
        
        const rawData = container.querySelector('pre').textContent;
        container.innerHTML = '';
        
        const branchGpaData = safeJSONParse(rawData);
        if (!branchGpaData || !branchGpaData.length) return;
        
        const traces = branchGpaData.map(branch => ({
            x: branch.semesters,
            y: branch.gpas,
            mode: 'lines+markers',
            name: branch.name
        }));
        
        const layout = {
            modebar: {
                remove: [
                    "pan",
                    "zoom",
                    "zoomIn",
                    "zoomOut",
                    "lasso2d",
                    "resetScale2d"
                ]
            },
            yaxis: { title: "GPA" },
            template: "plotly_white",
            autosize: true,
            height: 400,
            margin: { l: 50, r: 50, b: 80, t: 30, pad: 4 }
        };
        
        Plotly.newPlot(container, traces, layout);
    }
    
    function generateCombinedGPACGPAChart() {
        const container = document.getElementById('combined-chart-data');
        if (!container) return;
        
        const rawData = container.querySelector('pre').textContent;
        container.innerHTML = '';
        
        const combinedData = safeJSONParse(rawData);
        if (!combinedData || !combinedData.semesters) return;
        
        const traces = [
            {
                x: combinedData.semesters,
                y: combinedData.gpa.values,
                mode: 'lines+markers',
                name: combinedData.gpa.name,
                line: { color: combinedData.gpa.color || 'blue' }
            },
            {
                x: combinedData.semesters,
                y: combinedData.cgpa.values,
                mode: 'lines+markers',
                name: combinedData.cgpa.name,
                line: { color: combinedData.cgpa.color || 'orange' }
            }
        ];
        
        const layout = {
            modebar: {
                remove: [
                    "pan",
                    "zoom",
                    "zoomIn",
                    "zoomOut",
                    "lasso2d",
                    "resetScale2d"
                ]
            },
            yaxis: { title: "Value" },
            template: "plotly_white",
            autosize: true,
            height: 400,
            margin: { l: 50, r: 50, b: 80, t: 30, pad: 4 }
        };
        
        Plotly.newPlot(container, traces, layout);
    }

    function generateLevelBoxplot() {
        const container = document.getElementById('level-boxplot-data');
        if (!container) return;
        
        const rawData = container.querySelector('pre').textContent;
        container.innerHTML = '';
        
        const boxplotData = safeJSONParse(rawData);
        if (!boxplotData || !boxplotData.data) return;
        
        Plotly.newPlot(container, boxplotData.data, boxplotData.layout);
    }

    function generateSemesterBoxplot() {
        const container = document.getElementById('semester-boxplot-data');
        if (!container) return;
        
        const rawData = container.querySelector('pre').textContent;
        container.innerHTML = '';
        
        const boxplotData = safeJSONParse(rawData);
        if (!boxplotData || !boxplotData.data) return;

        Plotly.newPlot(container, boxplotData.data, boxplotData.layout);
    }

    function generateAllScoresBoxplot() {
        const container = document.getElementById('all-boxplot-data');
        if (!container) return;
        
        // Get the raw data and clear the container
        const rawData = container.querySelector('pre').textContent;
        container.innerHTML = '';
        
        const boxplotData = safeJSONParse(rawData);
        if (!boxplotData || !boxplotData.data) return;
        
        Plotly.newPlot(container, boxplotData.data, boxplotData.layout);
    }

    // Generate Semester Average Score Chart
    function generateSemesterAvgChart() {
        const container = document.getElementById('semester-avg-data');
        if (!container) return;
        
        // Get the raw data and clear the container
        const rawData = container.querySelector('pre').textContent;
        container.innerHTML = '';
        
        const semesterAvgData = safeJSONParse(rawData);
        if (!semesterAvgData || !semesterAvgData.type) return;
        
        // Create the trace using the provided data
        const trace = {
            x: semesterAvgData.data.x,
            y: semesterAvgData.data.y,
            mode: semesterAvgData.data.mode || 'lines+markers',
            name: semesterAvgData.data.name,
            marker: semesterAvgData.data.marker
        };
        
        // Configure layout based on backend settings
        const layout = {
            modebar: semesterAvgData.layout.modebar,
            yaxis: { title: semesterAvgData.layout.yaxis_title },
            template: "plotly_white",
            autosize: true,
            height: 400,
            margin: { l: 50, r: 50, b: 80, t: 30, pad: 4 }
        };
        
        // Create the plot
        Plotly.newPlot(container, [trace], layout);
    }

// Generate Branch Average Score Chart
    function generateBranchAvgChart() {
        const container = document.getElementById('branch-avg-data');
        if (!container) return;
        
        // Get the raw data and clear the container
        const rawData = container.querySelector('pre').textContent;
        container.innerHTML = '';
        
        const branchAvgData = safeJSONParse(rawData);
        if (!branchAvgData || !branchAvgData.type || branchAvgData.type !== 'multi_scatter') return;
    
        // Create traces for each branch using the provided data
        const traces = branchAvgData.data.map(branch => ({
            x: branch.x,
            y: branch.y,
            mode: branch.mode || 'lines+markers',
            name: branch.name,
            marker: branch.marker,
            connectgaps: branch.connectgaps
        }));
    
        // Configure layout based on backend settings
        const layout = {
            modebar: branchAvgData.layout.modebar,
            yaxis: { title: branchAvgData.layout.yaxis_title },
            legend: { title: branchAvgData.layout.legend_title },
            template: "plotly_white",
            autosize: true,
            height: 400,
            margin: { l: 50, r: 50, b: 80, t: 30, pad: 4 }
        };
    
        // Create the plot
        Plotly.newPlot(container, traces, layout);
    }

    function generateScatterPlot() {
      const container = document.getElementById('scatter-plot-container');
      if (!container) return;
        
      // Get the raw data and clear the container
      const rawData = container.querySelector('pre').textContent;
      container.innerHTML = '';
        
      const scatterData = safeJSONParse(rawData);
      if (!scatterData || !scatterData.data) return;
      
      const trace = {
          x: scatterData.data.x,
          y: scatterData.data.y,
          mode: scatterData.data.mode || 'markers',
          marker: scatterData.data.marker || {
              size: 7,
              color: 'red',
              opacity: 0.6
          },
          text: scatterData.data.text,
          type: scatterData.type || 'scatter'
      };
        
      const layout = {
          yaxis: { title: scatterData.layout.yaxis_title || 'Scores' },
          template: scatterData.layout.template || 'plotly_white',
          xaxis: scatterData.layout.xaxis || {
              tickangle: 60,
              tickfont: { size: 11, style: 'italic' }
          },
          modebar: scatterData.layout.modebar || {
                remove: ["pan", "zoom", "zoomIn", "zoomOut", "lasso2d", "resetScale2d"]
          },
          autosize: true,
          height: 400,
          margin: { l: 50, r: 50, b: 120, t: 30, pad: 4 }
      };
        
      Plotly.newPlot(container, [trace], layout);
    }

    // Generate Course Pass Rate Chart
    function generatePassRateChart() {
        const container = document.getElementById('pass-rate-data');
        if (!container) return;
        
        // Get the raw data and clear the container
        const rawData = container.querySelector('pre').textContent;
        container.innerHTML = '';
        
        const passRateData = safeJSONParse(rawData);
        if (!passRateData || !passRateData.semesters || !passRateData.branches) return;
        
        const semesters = passRateData.semesters;
        const branches = passRateData.branches;
        
        // Create traces for each branch - one for total courses and one for passed courses
        const traces = [];
        
        // Loop through each branch and create traces for both total and passed courses
        Object.entries(branches).forEach(([branchName, branchData]) => {
            // Total courses trace
            traces.push({
                x: semesters,
                y: branchData.total,
                type: 'bar',
                name: `${branchName} (Total)`,
                marker: {
                    color: branchData.color,
                    opacity: 0.7
                },
                hoverinfo: 'none',
            });
            
            // Passed courses trace
            traces.push({
                x: semesters,
                y: branchData.passed,
                type: 'bar',
                name: `${branchName} (Passed)`,
                marker: {
                    color: branchData.color,
                    opacity: 1.0
                },
                hoverinfo: 'none',
            });
        });
        
        // Configure layout according to chart settings
        const layout = {
            barmode: passRateData.chart_settings.barmode || 'group',
            yaxis: { 
                title: passRateData.chart_settings.yaxis_title || "Number of Courses" 
            },
            xaxis: {
                tickangle: 20,
                fontsize: 8,
            },
            plot_bgcolor: passRateData.chart_settings.plot_bgcolor || '#ffffcc',
            height: passRateData.chart_settings.height || 500,
            template: "plotly_white",
            legend: {
                orientation: "h",
                yanchor: "bottom",
                y: 1.02,
                xanchor: "right",
                x: 1
            },
            modebar: {
                remove: [
                    "pan",
                    "zoom",
                    "zoomIn",
                    "zoomOut",
                    "lasso2d",
                    "resetScale2d"
                ]
            },
            margin: { l: 60, r: 30, b: 100, t: 30, pad: 4 },
        };
        
        // Create the plot
        Plotly.newPlot(container, traces, layout);
    }

        // Generate Branch Distribution Stacked Chart
    function generateBranchDistributionChart() {
        const container = document.getElementById('branch-distribution-chart');
        if (!container) return;
        
        // Get the raw data and clear the container
        const rawData = container.querySelector('pre').textContent;
        container.innerHTML = '';
        
        const branchData = safeJSONParse(rawData);
        if (!branchData || !branchData.semesters.length === 0) return;
        
        // Create traces for each branch
        const traces = branchData.branches.map(branch => ({
            x: branchData.semesters,
            y: branch.counts,
            type: 'bar',
            name: branch.name,
            marker: {
                color: branch.color
            }
        }));
        
        // Configure layout based on the backend configuration
        const layout = {
            modebar: {
                remove: [
                    "pan",
                    "zoom",
                    "zoomIn",
                    "zoomOut",
                    "lasso2d",
                    "resetScale2d"
                ]
            },
            yaxis: { title: branchData.layout.yaxis_title },
            xaxis: { title: "Semester" },
            barmode: branchData.layout.barmode,
            bargap: branchData.layout.bargap,
            template: branchData.layout.template,
            autosize: true,
            height: branchData.layout.height,
            margin: { l: 50, r: 50, b: 80, t: 30, pad: 4 }
        };
        
        // Create the plot
        Plotly.newPlot(container, traces, layout);
    }

    // Generate Overall Branch Pie Chart
    function generateOverallBranchPieChart() {
        const container = document.querySelector('.branch-pie-chart .raw-data pre');
        if (!container) return;
        
        // Get the container element and parent
        const containerParent = container.parentElement.parentElement;
        
        // Get the raw data and clear the parent container
        const rawData = container.textContent;
        containerParent.removeChild(container.parentElement);
        
        // Create a new div for the chart
        const chartDiv = document.createElement('div');
        chartDiv.id = 'branch-pie-chart';
        containerParent.appendChild(chartDiv);
        
        const pieData = safeJSONParse(rawData);
        if (!pieData || !pieData.data || !pieData.data.length) return;
        
        // Create the trace for the pie chart
        const trace = {
            type: 'pie',
            labels: pieData.data[0].labels,
            values: pieData.data[0].values,
            marker: {
                colors: pieData.data[0].marker.colors
            }
        };
        
        // Configure layout to match backend configuration
        const layout = {
            template: pieData.layout.template || 'plotly_white',
            height: pieData.layout.height || 580,
            margin: pieData.layout.margin || { l: 40, r: 40, t: 50, b: 5 },
            legend: {
                orientation: 'h',
                yanchor: 'bottom',
                y: -0.2,
                xanchor: 'center',
                x: 0.5
            }
        };
        
        // Create the plot
        Plotly.newPlot('branch-pie-chart', [trace], layout);
    }

    function initializeCharts() {
        generateBranchGPAChart();
        generateCombinedGPACGPAChart();
        
        generateLevelBoxplot();
        generateSemesterBoxplot();
        generateAllScoresBoxplot();

        generateSemesterAvgChart();
        generateBranchAvgChart();

        generateScatterPlot();
        generatePassRateChart();
        generateBranchDistributionChart()
        generateOverallBranchPieChart()
    }

    initializeCharts()
});
</script>
<script src="{% static 'js/visualizer.js' %}" defer></script>

{% endblock %}